#!/bin/bash
#SBATCH --job-name=xpnsl_BomTerr1_2
#SBATCH --output=xpnsl_BomTerr1_2_%j.out
#SBATCH --error=xpnsl_BomTerr1_2_%j.err
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=20 
#SBATCH --mem=12G
#SBATCH --time=2:00:00
#SBATCH --partition=parallel
#SBATCH -C skylake
#SBATCH --account=m2_jgu-salmosex

# -------------------------------
# Load the stuff we need
# -------------------------------
module purge
# I think we need bcftools to filter VCFs by sample
module load bio/BCFtools/1.14-GCC-11.2.0 
# VCFtools might be needed for extra VCF operations
module load bio/VCFtools/0.1.16-GCC-11.2.0
# Load R and Bioconductor just in case we need them later
module load bio/R-bundle-Bioconductor/3.15-foss-2021b-R-4.2.0

# -------------------------------
# Set paths and parameters
# -------------------------------
VCF_DIR="/lustre/miifs01/project/m2_jgu-salmosex/nina/Population_genomics_results/xp-nsl/bomterr_new"
OUTPUT_DIR="/lustre/miifs01/project/m2_jgu-salmosex/nina/Population_genomics_results/xp-nsl/xpnsl_BomTerr1_2"
SELSCAN="/lustre/miifs01/project/m2_jgu-salmosex/nina/jobscripts/selscan/src/selscan"

# This file tells us which sample belongs to which population
POP_MAP_FILE="/lustre/miifs01/project/m2_jgu-salmosex/nina/jobscripts/pop.txt"

# Where we're gonna save sample lists
WILD_SAMPLES="$OUTPUT_DIR/wild_samples.txt"
COMMERCIAL_SAMPLES="$OUTPUT_DIR/commercial_samples.txt"

THREADS=20

# Make output folders if they don't exist yet
mkdir -p "$OUTPUT_DIR/results"
mkdir -p "$OUTPUT_DIR/temp" # temp files go here

# -------------------------------
# Step 1: Make sample lists
# -------------------------------
echo "Making sample lists from $POP_MAP_FILE..."
# grab all wild samples
awk '$2 == "wild" {print $1}' "$POP_MAP_FILE" > "$WILD_SAMPLES"
# grab all commercial samples
awk '$2 == "commercial" {print $1}' "$POP_MAP_FILE" > "$COMMERCIAL_SAMPLES"

# Count samples so we know what we're working with
WILD_COUNT=$(wc -l < "$WILD_SAMPLES")
COMM_COUNT=$(wc -l < "$COMMERCIAL_SAMPLES")
echo "Wild list has $WILD_COUNT samples."
echo "Commercial list has $COMM_COUNT samples."

# -------------------------------
# Step 2: Loop through chromosomes and run XP-nSL
# -------------------------------
echo "Filtering VCFs and running selscan..."

# Loop through all chromosome VCFs
for CHR_VCF in $VCF_DIR/phased.NC_*.vcf.gz; do
    CHR=$(basename $CHR_VCF .vcf.gz)
    echo "Working on $CHR_VCF"

    # paths for temporary filtered VCFs
    WILD_VCF="$OUTPUT_DIR/temp/${CHR}_wild.vcf.gz"
    COMMERCIAL_VCF="$OUTPUT_DIR/temp/${CHR}_commercial.vcf.gz"
    
    # Filter for wild samples
    echo "  - Filtering for wild samples..."
    bcftools view \
        --samples-file "$WILD_SAMPLES" \
        --output-file "$WILD_VCF" \
        --output-type z \
        --force-samples \
        "$CHR_VCF"
        
    # Filter for commercial samples
    echo "  - Filtering for commercial samples..."
    bcftools view \
        --samples-file "$COMMERCIAL_SAMPLES" \
        --output-file "$COMMERCIAL_VCF" \
        --output-type z \
        --force-samples \
        "$CHR_VCF"

    # Run selscan XP-nSL
    # Note: wild = target, commercial = reference
    echo "  - Running selscan XP-nSL..."
    $SELSCAN --threads $THREADS \
        --xpnsl \
        --vcf "$WILD_VCF" \
        --vcf-ref "$COMMERCIAL_VCF" \
        --out "$OUTPUT_DIR/results/${CHR}_xpnsl"
        
    # Remove temporary filtered VCFs to save space
    echo "  - Deleting temporary VCFs..."
    rm -f "$WILD_VCF" "$COMMERCIAL_VCF"
done

